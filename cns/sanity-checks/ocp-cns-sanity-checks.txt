# Verify Installation Resources

# Examine the installation for the app-storage namespace (on the CNS cluster) by running the following commands (from the master node or the ansible deploy host that has the heketi-cli tool installed):

=============================================================================================================================
[root@ose-master01 ~]# oc project app-storage
Already on project "app-storage" on server "https://ose-master01.example.com:8443".

[root@ose-master01 ~]# oc get po
NAME                      READY     STATUS    RESTARTS   AGE
glusterfs-storage-7jr2k   1/1       Running   1          13h
glusterfs-storage-d2bjj   1/1       Running   1          13h
glusterfs-storage-txk4z   1/1       Running   1          13h
heketi-storage-1-n9kds    1/1       Running   0          6h

[root@ose-master01 ~]# source heketi-exports-app 

[root@ose-master01 ~]# curl -w '\n' ${HEKETI_CLI_SERVER}/hello
Hello from Heketi

[root@ose-master01 ~]# heketi-cli cluster list 
Clusters:
Id:81872361a44f45acaf79ba8367411af0 [file][block]

[root@ose-master01 ~]# heketi-cli topology info | tail -n 10
        Devices:
                Id:b7223b3d4d2d82ec34db0b22d1b31dd2   Name:/dev/vdc            State:online    Size (GiB):99      Used (GiB):35      Free (GiB):64      
                        Bricks:
                                Id:23d6b5c7734b879b3ff35538c4520fe6   Size (GiB):10      Path: /var/lib/heketi/mounts/vg_b7223b3d4d2d82ec34db0b22d1b31dd2/brick_23d6b5c7734b879b3ff35538c4520fe6/brick
                                Id:647920b3cba93c70da98bd03814c3108   Size (GiB):10      Path: /var/lib/heketi/mounts/vg_b7223b3d4d2d82ec34db0b22d1b31dd2/brick_647920b3cba93c70da98bd03814c3108/brick
                                Id:73494c7a7cc0373743379d8eedafc3a2   Size (GiB):1       Path: /var/lib/heketi/mounts/vg_b7223b3d4d2d82ec34db0b22d1b31dd2/brick_73494c7a7cc0373743379d8eedafc3a2/brick
                                Id:7c644dfcb4705915057b3f132f58f584   Size (GiB):1       Path: /var/lib/heketi/mounts/vg_b7223b3d4d2d82ec34db0b22d1b31dd2/brick_7c644dfcb4705915057b3f132f58f584/brick
                                Id:8ab830d3b6176610b5cc7bb865a5c8a1   Size (GiB):10      Path: /var/lib/heketi/mounts/vg_b7223b3d4d2d82ec34db0b22d1b31dd2/brick_8ab830d3b6176610b5cc7bb865a5c8a1/brick
                                Id:9c045b2d2d94a420034fd1e3b5a6ee8e   Size (GiB):2       Path: /var/lib/heketi/mounts/vg_b7223b3d4d2d82ec34db0b22d1b31dd2/brick_9c045b2d2d94a420034fd1e3b5a6ee8e/brick
                                Id:fc4c45e5041a2f1d839812f51c121f99   Size (GiB):1       Path: /var/lib/heketi/mounts/vg_b7223b3d4d2d82ec34db0b22d1b31dd2/brick_fc4c45e5041a2f1d839812f51c121f99/brick
 
[root@ose-master01 ~]# heketi-cli volume list
Id:2ae336589d0af1846975866dd85f35fd    Cluster:81872361a44f45acaf79ba8367411af0    Name:vol_2ae336589d0af1846975866dd85f35fd
Id:3a9b113a16b09ceda3ed36b3b8c5b643    Cluster:81872361a44f45acaf79ba8367411af0    Name:vol_3a9b113a16b09ceda3ed36b3b8c5b643
Id:7220d5c813934e0efa64fb6ea5e4c321    Cluster:81872361a44f45acaf79ba8367411af0    Name:heketidbstorage
Id:941c472663b7839de16a05a3b3e6fd18    Cluster:81872361a44f45acaf79ba8367411af0    Name:vol_941c472663b7839de16a05a3b3e6fd18
Id:a047f64ae624ea469618e2a987085c15    Cluster:81872361a44f45acaf79ba8367411af0    Name:vol_a047f64ae624ea469618e2a987085c15
Id:b5c4527f296264c7d79d990b3b3db6ba    Cluster:81872361a44f45acaf79ba8367411af0    Name:vol_b5c4527f296264c7d79d990b3b3db6ba
Id:d5db1fdada453420046ad4f185b95356    Cluster:81872361a44f45acaf79ba8367411af0    Name:vol_d5db1fdada453420046ad4f185b95356
=============================================================================================================================

# Examine the installation for the infra-storage namespace (on the CNS cluster) by running the following commands (from the master node that has the heketi-cli tool installed):


=============================================================================================================================
[root@ose-master01 ~]# oc project infra-storage
Already on project "infra-storage" on server "https://ose-master01.example.com:8443".

[root@ose-master01 ~]# oc get po
NAME                                           READY     STATUS    RESTARTS   AGE
glusterblock-registry-provisioner-dc-1-wqqw4   1/1       Running   1          12h
glusterfs-registry-tcggp                       1/1       Running   1          12h
glusterfs-registry-xgh9c                       1/1       Running   1          12h
glusterfs-registry-zqtrs                       1/1       Running   1          12h
heketi-registry-1-ss6hm                        1/1       Running   1          12h

[root@ose-master01 ~]# source heketi-exports-infra 

[root@ose-master01 ~]# curl -w '\n' ${HEKETI_CLI_SERVER}/hello
Hello from Heketi

[root@ose-master01 ~]# heketi-cli cluster list
Clusters:
Id:45b8c5b94be5d933b609dc1e0f538430 [file][block]

[root@ose-master01 ~]# heketi-cli topology info | tail -n 10
        Cluster Id: 45b8c5b94be5d933b609dc1e0f538430
        Zone: 2
        Management Hostnames: ose-infra-node02.example.com
        Storage Hostnames: 192.168.122.58
        Devices:
                Id:06ff9c97548a5790fedc7bb458740c35   Name:/dev/vdc            State:online    Size (GiB):99      Used (GiB):77      Free (GiB):22      
                        Bricks:
                                Id:7db2c80a105cc94a092c3afcfd0c84f2   Size (GiB):2       Path: /var/lib/heketi/mounts/vg_06ff9c97548a5790fedc7bb458740c35/brick_7db2c80a105cc94a092c3afcfd0c84f2/brick
                                Id:ab906453e20e0918f811d30b86b61f5f   Size (GiB):25      Path: /var/lib/heketi/mounts/vg_06ff9c97548a5790fedc7bb458740c35/brick_ab906453e20e0918f811d30b86b61f5f/brick
                                Id:ce779ec0a02b44f4b819a1039adeff59   Size (GiB):50      Path: /var/lib/heketi/mounts/vg_06ff9c97548a5790fedc7bb458740c35/brick_ce779ec0a02b44f4b819a1039adeff59/brick

[root@ose-master01 ~]# heketi-cli volume list
Id:84cb9822eb0fa3191d8a7695ccc02cf0    Cluster:45b8c5b94be5d933b609dc1e0f538430    Name:glusterfs-registry-volume
Id:8c0fb4060c0e0c813b59da52ef450d1b    Cluster:45b8c5b94be5d933b609dc1e0f538430    Name:vol_8c0fb4060c0e0c813b59da52ef450d1b [block]
Id:ff647c24d99f36f934a926f9ff12d232    Cluster:45b8c5b94be5d933b609dc1e0f538430    Name:heketidbstorage

[root@ose-master01 ~]# oc get pvc -n default
NAME             STATUS    VOLUME            CAPACITY   ACCESS MODES   STORAGECLASS   AGE
registry-claim   Bound     registry-volume   25Gi       RWX                           12h

[root@ose-master01 ~]# 

[root@ose-master01 ~]# oc describe dc/docker-registry -n default | grep -A3 Volumes
  Volumes:
   registry-storage:
    Type:       PersistentVolumeClaim (a reference to a PersistentVolumeClaim in the same namespace)
    ClaimName:  registry-claim
=============================================================================================================================

# Storage Functionality

=============================================================================================================================

[root@ose-master01 ~]# oc get sc
NAME                          PROVISIONER                AGE
glusterfs-registry-block      gluster.org/glusterblock   12h
glusterfs-storage (default)   kubernetes.io/glusterfs    13h

[root@ose-master01 ~]# cat pvc-file.yaml 
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
 name: chc-claim1 
 annotations:
   volume.beta.kubernetes.io/storage-class: glusterfs-storage
spec:
 accessModes:
   - ReadWriteMany
 resources:
   requests:
     storage: 1Gi

[root@ose-master01 ~]# oc create -f pvc-file.yaml 
persistentvolumeclaim "chc-claim1" created
[root@ose-master01 ~]# cat pvc-block.yaml 
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
 name: chc-block-claim
 annotations:
   volume.beta.kubernetes.io/storage-class: glusterfs-registry-block
spec:
 accessModes:
   - ReadWriteOnce
 resources:
   requests:
     storage: 1Gi

[root@ose-master01 ~]# oc create -f pvc-block.yaml 
persistentvolumeclaim "chc-block-claim" created

[root@ose-master01 ~]# oc get pvc
NAME              STATUS    VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS               AGE
chc-block-claim   Bound     pvc-1c0407fb-68ca-11e8-9a04-5254006ba8c8   1Gi        RWO            glusterfs-registry-block   24s
chc-claim1        Bound     pvc-138a4171-68ca-11e8-9a04-5254006ba8c8   1Gi        RWX            glusterfs-storage          38s

[root@ose-master01 ~]# oc get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS    CLAIM                                   STORAGECLASS               REASON    AGE
pvc-1144a8ae-6868-11e8-9522-5254006ba8c8   10Gi       RWO            Delete           Bound     openshift-infra/metrics-cassandra-1     glusterfs-registry-block             11h
pvc-138a4171-68ca-11e8-9a04-5254006ba8c8   1Gi        RWX            Delete           Bound     infra-storage/chc-claim1                glusterfs-storage                    2m
pvc-16cb34f7-6879-11e8-9522-5254006ba8c8   1Gi        RWO            Delete           Bound     chc-test-project/mariadb                glusterfs-storage                    9h
pvc-1c0407fb-68ca-11e8-9a04-5254006ba8c8   1Gi        RWO            Delete           Bound     infra-storage/chc-block-claim           glusterfs-registry-block             2m
pvc-a6002f3c-6866-11e8-9522-5254006ba8c8   10Gi       RWO            Delete           Bound     logging/logging-es-0                    glusterfs-storage                    11h
pvc-b89a21f6-685d-11e8-9522-5254006ba8c8   1Gi        RWO            Delete           Bound     openshift-ansible-service-broker/etcd   glusterfs-storage                    12h
pvc-c25aaebe-6866-11e8-9522-5254006ba8c8   10Gi       RWO            Delete           Bound     logging/logging-es-1                    glusterfs-storage                    11h
pvc-e07e7f5e-6866-11e8-9522-5254006ba8c8   10Gi       RWO            Delete           Bound     logging/logging-es-2                    glusterfs-storage                    11h
pvc-f43b9a5b-6874-11e8-9522-5254006ba8c8   1Gi        RWX            Delete           Bound     chc-test-project/chc-claim1             glusterfs-storage                    10h
registry-volume                            25Gi       RWX            Retain           Bound     default/registry-claim                                                       13h

=============================================================================================================================

#Examine the state of CNS the by running the following commands (from the master node that has the heketi-cli tool installed):

=============================================================================================================================

[root@ose-master01 ~]# oc project infra-storage
Already on project "infra-storage" on server "https://ose-master01.example.com:8443".

[root@ose-master01 ~]# export CNS_INFRA_POD1=$(oc get pods -l glusterfs=registry-pod -n infra-storage -o jsonpath="{.items[0].metadata.name}")

[root@ose-master01 ~]# oc rsh ${CNS_INFRA_POD1} systemctl status gluster-blockd
● gluster-blockd.service - Gluster block storage utility
   Loaded: loaded (/usr/lib/systemd/system/gluster-blockd.service; enabled; vendor preset: disabled)
   Active: active (running) since Tue 2018-06-05 13:41:27 UTC; 32min ago
 Main PID: 496 (gluster-blockd)
   CGroup: /kubepods.slice/kubepods-burstable.slice/kubepods-burstable-podc76d8ebc_685b_11e8_9c3a_52540063e104.slice/docker-03608a89f89c8519e4a5f75e7a924929c3d94241baf3df3385d3509251f2f108.scope/system.slice/gluster-blockd.service
           └─496 /usr/sbin/gluster-blockd --glfs-lru-count 15 --log-level INF...

Jun 05 13:41:27 ose-infra-node03.example.com systemd[1]: Started Gluster bloc...
Jun 05 13:41:27 ose-infra-node03.example.com systemd[1]: Starting Gluster blo...
Jun 05 13:41:27 ose-infra-node03.example.com gluster-blockd[496]: Parameter l...
Jun 05 13:41:27 ose-infra-node03.example.com gluster-blockd[496]: Parameter l...
Jun 05 13:41:28 ose-infra-node03.example.com gluster-blockd[496]: Parameter a...
Jun 05 13:41:28 ose-infra-node03.example.com gluster-blockd[496]: Parameter a...
Jun 05 13:41:28 ose-infra-node03.example.com gluster-blockd[496]: Last 10 con...
Jun 05 13:41:28 ose-infra-node03.example.com gluster-blockd[496]: Configurati...
Hint: Some lines were ellipsized, use -l to show in full.

=============================================================================================================================
